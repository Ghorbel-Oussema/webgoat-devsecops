name: Security Pipeline (SAST + DAST)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 2 * * *" # scan nightly

permissions:
  contents: read
  security-events: write
  actions: read
  packages: read

# ==========================
# OPTIONAL SECRETS (add later)
# ==========================
# Semgrep Cloud (optional):
#   SEMGREP_APP_TOKEN = sgp_...
#
# SonarQube Community (optional):
#   SONAR_HOST_URL = http://<ip>:9000
#   SONAR_TOKEN    = sqp_...
#
# Bearer Cloud (optional):
#   BEARER_TOKEN = ...
#
# GitHub Advanced Security (CodeQL SARIF upload works with GITHUB_TOKEN)
#
# Nuclei (optional for private templates):
#   NUCLEI_TEMPLATES_TOKEN = ...
#
# OWASP ZAP (optional for authenticated scans):
#   WEBGOAT_USER = ...
#   WEBGOAT_PASS = ...

jobs:
  build-image:
    name: Info
    runs-on: ubuntu-latest
    steps:
      - name: Info
        run: echo "This workflow scans. Image build/push handled by push-image workflow."

  sast:
    name: SAST (Semgrep, CodeQL, Bearer, optional Node, optional Sonar)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ✅ Needed for mvn sonar:sonar + any Java-based steps
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Prepare reports directory
        run: |
          mkdir -p reports/sast/semgrep
          mkdir -p reports/sast/bearer
          mkdir -p reports/sast/codeql
          mkdir -p reports/sast/node
          mkdir -p reports/sast/sonarqube

      - name: Detect Node project
        id: detect_node
        run: |
          if [ -f package.json ]; then
            echo "has_node=true" >> $GITHUB_OUTPUT
          else
            echo "has_node=false" >> $GITHUB_OUTPUT
          fi

      # =========================
      # 1) Semgrep (SARIF)
      # =========================
      - name: Semgrep scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/security-audit"
          generateSarif: "1"
        env:
          # Optional: enable Semgrep Cloud later
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Save Semgrep outputs
        if: always()
        run: |
          if [ -f semgrep.sarif ]; then
            cp semgrep.sarif reports/sast/semgrep/semgrep.sarif
          fi

      - name: Upload Semgrep SARIF to GitHub Security
        if: always() && hashFiles('reports/sast/semgrep/semgrep.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/sast/semgrep/semgrep.sarif

      # =========
      # 2) CodeQL
      # =========
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          queries: security-extended

      - name: Autobuild (CodeQL)
        uses: github/codeql-action/autobuild@v3

      - name: CodeQL Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

      # =========================
      # 3) Bearer (JSON + SARIF)
      # =========================
      - name: Bearer scan (JSON + SARIF)
        run: |
          docker run --rm -v "$PWD:/repo" bearer/bearer:latest \
            scan /repo --format json --output /repo/reports/sast/bearer/bearer.json || true

          docker run --rm -v "$PWD:/repo" bearer/bearer:latest \
            scan /repo --format sarif --output /repo/reports/sast/bearer/bearer.sarif || true

      - name: Upload Bearer SARIF to GitHub Security
        if: always() && hashFiles('reports/sast/bearer/bearer.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/sast/bearer/bearer.sarif

      # =========================================
      # 4) Node tools (conditional)
      # =========================================
      - name: Setup Node
        if: steps.detect_node.outputs.has_node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        if: steps.detect_node.outputs.has_node == 'true'
        run: npm ci

      - name: ESLint Security (if configured)
        if: steps.detect_node.outputs.has_node == 'true'
        run: |
          npx eslint . -f json -o reports/sast/node/eslint-security.json || true

      - name: NodeJsScan (conditional)
        if: steps.detect_node.outputs.has_node == 'true'
        run: |
          pipx install nodejsscan || true
          nodejsscan -d . -o reports/sast/node/nodejsscan.json || true

      # =========================================
      # 5) SonarQube Community (optional)
      # Only runs if secrets exist
      # =========================================
      - name: SonarQube scan (optional)
        if: env.SONAR_TOKEN != '' && env.SONAR_HOST_URL != ''
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          mvn --no-transfer-progress -DskipTests sonar:sonar \
            -Dsonar.host.url="${SONAR_HOST_URL}" \
            -Dsonar.login="${SONAR_TOKEN}" \
            || true

      # --------------------------
      # OPTIONAL TOOLS (add later)
      # --------------------------
      # ✅ Semgrep JSON report (optional)
      # - name: Semgrep JSON (optional)
      #   run: semgrep --config p/security-audit --json -o reports/sast/semgrep/semgrep.json || true
      #
      # ✅ Trivy filesystem scan (dependencies + secrets)
      # - name: Trivy FS scan (optional)
      #   uses: aquasecurity/trivy-action@0.24.0
      #   with:
      #     scan-type: fs
      #     format: sarif
      #     output: reports/sast/trivy-fs.sarif
      #     ignore-unfixed: true
      #   env:
      #     TRIVY_DB_REPOSITORY: ghcr.io/aquasecurity/trivy-db

      - name: Upload SAST reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-reports
          path: reports/sast

  dast:
    name: DAST (WebGoat + ZAP + Nuclei + Wapiti)
    runs-on: ubuntu-latest
    needs: [sast]
    steps:
      - uses: actions/checkout@v4

      - name: Prepare reports directory
        run: |
          mkdir -p reports/dast/zap
          mkdir -p reports/dast/nuclei
          mkdir -p reports/dast/wapiti

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start WebGoat (docker compose)
        run: |
          docker compose up -d
          docker ps

      - name: Wait for WebGoat
        run: |
          for i in $(seq 1 60); do
            if curl -fsS http://localhost:8080/WebGoat/actuator/health >/dev/null; then
              echo "WebGoat is up!"
              exit 0
            fi
            sleep 5
          done
          echo "WebGoat did not become ready in time" >&2
          docker compose logs --no-color || true
          exit 1

      # =================
      # 1) OWASP ZAP
      # Outputs: HTML + JSON + XML
      # =================
      - name: ZAP Baseline Scan
        run: |
          docker run --rm --network host \
            -v "$PWD/reports/dast/zap:/zap/wrk" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t http://127.0.0.1:8080/WebGoat \
              -r zap-report.html \
              -J zap-report.json \
              -x zap-report.xml \
              || true

      # ==========
      # 2) Nuclei
      # Outputs: JSONL + SARIF
      # ==========
      - name: Nuclei scan
        run: |
          docker run --rm --network host \
            -v "$PWD/reports/dast/nuclei:/out" \
            projectdiscovery/nuclei:latest \
            -u http://127.0.0.1:8080/WebGoat \
            -severity low,medium,high,critical \
            -jsonl -o /out/nuclei.jsonl \
            || true

          docker run --rm --network host \
            -v "$PWD/reports/dast/nuclei:/out" \
            projectdiscovery/nuclei:latest \
            -u http://127.0.0.1:8080/WebGoat \
            -severity low,medium,high,critical \
            -sarif-export /out/nuclei.sarif \
            || true

      # ==========
      # 3) Wapiti
      # Outputs: HTML
      # ==========
      - name: Wapiti scan
        run: |
          docker run --rm --network host \
            -v "$PWD/reports/dast/wapiti:/out" \
            cyberwatch/wapiti:latest \
            wapiti -u http://127.0.0.1:8080/WebGoat \
              -f html -o /out/wapiti.html \
              || true

      # --------------------------
      # OPTIONAL DAST TOOLS (later)
      # --------------------------
      # ✅ Nikto (optional)
      # - name: Nikto scan (optional)
      #   run: |
      #     docker run --rm --network host sullo/nikto \
      #       -h http://127.0.0.1:8080/WebGoat \
      #       -o /tmp/nikto.txt || true
      #
      # ✅ Arachni / w3af / Vega: souvent instables en CI -> à activer seulement si besoin

      - name: Stop WebGoat
        if: always()
        run: docker compose down -v || true

      - name: Upload DAST reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: reports/dast
