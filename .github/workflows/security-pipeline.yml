name: Security Pipeline (SAST + DAST)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 2 * * *" # nightly scan

permissions:
  contents: read
  security-events: write
  actions: read
  packages: read

# ==========================
# OPTIONAL SECRETS (add later)
# ==========================
# Semgrep Cloud (optional):
#   SEMGREP_APP_TOKEN = sgp_...
#
# SonarQube Community (optional, not enabled by default here):
#   SONAR_HOST_URL = http://<ip>:9000
#   SONAR_TOKEN    = sqp_...
#
# ZAP authenticated scan (optional):
#   WEBGOAT_USER = ...
#   WEBGOAT_PASS = ...

jobs:
  sast:
    name: SAST (Semgrep + CodeQL + Bearer + optional Node)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Setup Python (for Semgrep)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prepare reports directory
        run: |
          mkdir -p reports/sast/semgrep
          mkdir -p reports/sast/bearer
          mkdir -p reports/sast/node
          mkdir -p reports/sast/debug

      - name: Detect Node project
        id: detect_node
        run: |
          if [ -f package.json ]; then
            echo "has_node=true" >> $GITHUB_OUTPUT
          else
            echo "has_node=false" >> $GITHUB_OUTPUT
          fi

      # =========================
      # 1) Semgrep (JSON + SARIF)
      # =========================
      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      - name: Semgrep scan (JSON + SARIF)
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }} # optional
        run: |
          semgrep --version
          semgrep --config p/security-audit --sarif -o reports/sast/semgrep/semgrep.sarif . || true
          semgrep --config p/security-audit --json  -o reports/sast/semgrep/semgrep.json  . || true

      - name: Upload Semgrep SARIF to GitHub Security
        if: always() && hashFiles('reports/sast/semgrep/semgrep.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/sast/semgrep/semgrep.sarif

      # =========
      # 2) CodeQL
      # =========
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java
          queries: security-extended

      - name: Autobuild (CodeQL)
        uses: github/codeql-action/autobuild@v4

      - name: Analyze (CodeQL)
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java"

      # =========================
      # 3) Bearer (JSON + SARIF)
      # =========================
      - name: Bearer scan (JSON + SARIF)
        run: |
          docker run --rm -v "$PWD:/repo" bearer/bearer:latest \
            scan /repo --format json --output /repo/reports/sast/bearer/bearer.json || true

          docker run --rm -v "$PWD:/repo" bearer/bearer:latest \
            scan /repo --format sarif --output /repo/reports/sast/bearer/bearer.sarif || true

      - name: Upload Bearer SARIF to GitHub Security
        if: always() && hashFiles('reports/sast/bearer/bearer.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/sast/bearer/bearer.sarif

      # =========================================
      # 4) Node tools (conditional)
      # =========================================
      - name: Setup Node
        if: steps.detect_node.outputs.has_node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node deps
        if: steps.detect_node.outputs.has_node == 'true'
        run: npm ci

      - name: ESLint (if configured)
        if: steps.detect_node.outputs.has_node == 'true'
        run: |
          npx eslint . -f json -o reports/sast/node/eslint.json || true

      - name: NodeJsScan (conditional)
        if: steps.detect_node.outputs.has_node == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install nodejsscan || true
          nodejsscan -d . -o reports/sast/node/nodejsscan.json || true

      - name: Debug list reports
        if: always()
        run: |
          echo "=== reports tree ==="
          ls -R reports || true

      - name: Upload SAST reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-reports
          path: reports/sast

  dast:
    name: DAST (WebGoat + ZAP + Nuclei + Wapiti)
    runs-on: ubuntu-latest
    needs: [sast]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare reports directory
        run: |
          mkdir -p reports/dast/zap
          mkdir -p reports/dast/nuclei
          mkdir -p reports/dast/wapiti
          mkdir -p reports/dast/debug

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Optional but helpful: ensure latest image is present
      - name: Pull latest WebGoat image
        run: |
          docker pull ghcr.io/ghorbel-oussema/webgoat-devsecops:latest

      - name: Start WebGoat (docker compose)
        run: |
          docker compose up -d
          docker ps

      - name: Wait for WebGoat
        run: |
          for i in $(seq 1 60); do
            if curl -fsS http://127.0.0.1:8080/WebGoat/actuator/health >/dev/null; then
              echo "WebGoat is up!"
              exit 0
            fi
            sleep 5
          done
          echo "WebGoat did not become ready in time" >&2
          docker compose logs --no-color || true
          exit 1

      # =================
      # 1) OWASP ZAP
      # Outputs: HTML + JSON + XML
      # =================
      - name: ZAP Baseline Scan
        run: |
          docker run --rm --network host \
            -v "$PWD/reports/dast/zap:/zap/wrk" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t http://127.0.0.1:8080/WebGoat \
              -r zap-report.html \
              -J zap-report.json \
              -x zap-report.xml \
              || true

      # ==========
      # 2) Nuclei
      # Outputs: JSONL + SARIF
      # ==========
      - name: Nuclei scan (JSONL + SARIF)
        run: |
          docker run --rm --network host \
            -v "$PWD/reports/dast/nuclei:/out" \
            projectdiscovery/nuclei:latest \
            -u http://127.0.0.1:8080/WebGoat \
            -severity low,medium,high,critical \
            -jsonl -o /out/nuclei.jsonl \
            || true

          docker run --rm --network host \
            -v "$PWD/reports/dast/nuclei:/out" \
            projectdiscovery/nuclei:latest \
            -u http://127.0.0.1:8080/WebGoat \
            -severity low,medium,high,critical \
            -sarif-export /out/nuclei.sarif \
            || true

      - name: Upload Nuclei SARIF to GitHub Security
        if: always() && hashFiles('reports/dast/nuclei/nuclei.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/dast/nuclei/nuclei.sarif

      # ==========
      # 3) Wapiti
      # Outputs: HTML
      # ==========
      - name: Wapiti scan
        run: |
          docker run --rm --network host \
            -v "$PWD/reports/dast/wapiti:/out" \
            cyberwatch/wapiti:latest \
            wapiti -u http://127.0.0.1:8080/WebGoat \
              -f html -o /out/wapiti.html \
              || true

      - name: Debug list reports
        if: always()
        run: |
          echo "=== reports tree ==="
          ls -R reports || true

      - name: Stop WebGoat
        if: always()
        run: docker compose down -v || true

      - name: Upload DAST reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: reports/dast
